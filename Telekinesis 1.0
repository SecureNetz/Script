--[[
    UNIVERSAL TELEKINESIS V5 (ULTIMATE OVERRIDE)
    Fixes: Self-Grabbing, Character Flinging, and Ownership Jitter
    Controls: [Q] Grab/Release | [E/R] Push/Pull | [Scroll] Distance
]]

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")

local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()
local Camera = workspace.CurrentCamera

--// CONFIG
local Reach = 1000
local PushSpeed = 5
local Distance = 20
local Target = nil
local IsHolding = false

--// UI (Charcoal Theme)
local ScreenGui = Instance.new("ScreenGui", game:GetService("CoreGui"))
local Indicator = Instance.new("Frame", ScreenGui)
Indicator.Size = UDim2.new(0, 120, 0, 40)
Indicator.Position = UDim2.new(0.5, -60, 0.1, 0)
Indicator.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
Indicator.BorderSizePixel = 0

local Status = Instance.new("TextLabel", Indicator)
Status.Size = UDim2.new(1, 0, 1, 0)
Status.TextColor3 = Color3.fromRGB(200, 200, 200)
Status.Text = "READY [Q]"
Status.Font = Enum.Font.Code
Status.BackgroundTransparency = 1

--// LOGIC
local function IsMovable(part)
    if not part or not part:IsA("BasePart") then return false end
    if part.Anchored then return false end
    if part:IsDescendantOf(LocalPlayer.Character) then return false end -- NEVER GRAB SELF
    return true
end

local function Release()
    if Target then
        -- Restore physics state
        pcall(function()
            Target.CanCollide = true
            Target.Velocity = Vector3.new(0,0,0)
        end)
    end
    Target = nil
    IsHolding = false
    Status.Text = "READY [Q]"
    Status.TextColor3 = Color3.fromRGB(200, 200, 200)
end

local function Grab()
    local hit = Mouse.Target
    if hit and IsMovable(hit) then
        Target = hit
        IsHolding = true
        Distance = (Camera.CFrame.Position - hit.Position).Magnitude
        Status.Text = "HOLDING: " .. hit.Name:sub(1,10)
        Status.TextColor3 = Color3.fromRGB(100, 255, 100)
        
        -- Disable collision with player to prevent flinging
        pcall(function()
            Target.CanCollide = false
        end)
    else
        Status.Text = "INVALID TARGET"
        task.wait(0.5)
        if not IsHolding then Status.Text = "READY [Q]" end
    end
end

--// THE ENGINE
RunService.RenderStepped:Connect(function()
    if IsHolding and Target then
        if not Target.Parent or Target.Anchored then
            Release()
            return
        end

        -- Calculate position in front of camera
        local unitRay = Mouse.UnitRay
        local targetPos = unitRay.Origin + (unitRay.Direction * Distance)
        
        -- FORCE CFRAME (The "Strongest" method)
        Target.Velocity = Vector3.new(0, 0, 0)
        Target.RotVelocity = Vector3.new(0, 0, 0)
        Target.CFrame = CFrame.new(targetPos)
    end
end)

--// INPUTS
UIS.InputBegan:Connect(function(input, gpe)
    if gpe then return end
    
    if input.KeyCode == Enum.KeyCode.Q then
        if IsHolding then Release() else Grab() end
    elseif input.KeyCode == Enum.KeyCode.E then
        Distance = Distance + PushSpeed
    elseif input.KeyCode == Enum.KeyCode.R then
        Distance = math.max(5, Distance - PushSpeed)
    end
end)

-- Mouse Scroll support for PC users
UIS.InputChanged:Connect(function(input)
    if IsHolding and input.UserInputType == Enum.UserInputType.MouseWheel then
        Distance = math.clamp(Distance + (input.Position.Z * Reach * 0.05), 5, Reach)
    end
end)

print("TK V5: Character Filter Active")
